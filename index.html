<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Agenda Coran - Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…">
    <meta name="theme-color" content="#208085">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Agenda Coran">
    <link rel="apple-touch-icon" href="/images/apple-touch-icon-180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/icon-128.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</title>
    <style>
        :root {
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);
  --color-purple-500: rgba(168, 85, 247, 1);
  --color-purple-600: rgba(147, 51, 234, 1);
  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;
  --color-bg-1: rgba(59, 130, 246, 0.08);
  --color-bg-2: rgba(245, 158, 11, 0.08);
  --color-bg-3: rgba(34, 197, 94, 0.08);
  --color-bg-4: rgba(239, 68, 68, 0.08);
  --color-bg-5: rgba(147, 51, 234, 0.08);
  --color-bg-6: rgba(249, 115, 22, 0.08);
  --color-bg-7: rgba(236, 72, 153, 0.08);
  --color-bg-8: rgba(6, 182, 212, 0.08);
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);
  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);
  --status-bg-opacity: 0.15;
  --status-border-opacity: 0.25;
  --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  --color-success-rgb: 33, 128, 141;
  --color-error-rgb: 192, 21, 47;
  --color-warning-rgb: 168, 75, 47;
  --color-info-rgb: 98, 108, 113;
  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;
  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;
  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;
  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);
  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
  --container-sm: 640px;
  --container-md: 768px;
  --container-lg: 1024px;
  --container-xl: 1280px;
}

@media (prefers-color-scheme: dark) {
  :root {
    --color-gray-400-rgb: 119, 124, 124;
    --color-teal-300-rgb: 50, 184, 198;
    --color-gray-300-rgb: 167, 169, 169;
    --color-gray-200-rgb: 245, 245, 245;
    --color-bg-1: rgba(29, 78, 216, 0.15);
    --color-bg-2: rgba(180, 83, 9, 0.15);
    --color-bg-3: rgba(21, 128, 61, 0.15);
    --color-bg-4: rgba(185, 28, 28, 0.15);
    --color-bg-5: rgba(107, 33, 168, 0.15);
    --color-bg-6: rgba(194, 65, 12, 0.15);
    --color-bg-7: rgba(190, 24, 93, 0.15);
    --color-bg-8: rgba(8, 145, 178, 0.15);
    --color-background: var(--color-charcoal-700);
    --color-surface: var(--color-charcoal-800);
    --color-text: var(--color-gray-200);
    --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
    --color-primary: var(--color-teal-300);
    --color-primary-hover: var(--color-teal-400);
    --color-primary-active: var(--color-teal-800);
    --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
    --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
    --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
    --color-border: rgba(var(--color-gray-400-rgb), 0.3);
    --color-error: var(--color-red-400);
    --color-success: var(--color-teal-300);
    --color-warning: var(--color-orange-400);
    --color-info: var(--color-gray-300);
    --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
    --color-btn-primary-text: var(--color-slate-900);
    --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
    --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
    --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.15);
    --button-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
    --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
    --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);
    --color-success-rgb: var(--color-teal-300-rgb);
    --color-error-rgb: var(--color-red-400-rgb);
    --color-warning-rgb: var(--color-orange-400-rgb);
    --color-info-rgb: var(--color-gray-300-rgb);
  }
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: var(--font-family-base); background-color: var(--color-background); color: var(--color-text); line-height: var(--line-height-normal); padding: var(--space-16); }
.container { max-width: var(--container-md); margin: 0 auto; }
.card { background-color: var(--color-surface); border-radius: var(--radius-lg); border: 1px solid var(--color-card-border); padding: var(--space-24); margin-bottom: var(--space-16); box-shadow: var(--shadow-sm); }
.header { text-align: center; margin-bottom: var(--space-32); }
.header h1 { font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-primary); margin-bottom: var(--space-8); }
.btn { display: inline-block; padding: var(--space-12) var(--space-24); border: none; border-radius: var(--radius-base); font-size: var(--font-size-base); font-weight: var(--font-weight-medium); cursor: pointer; transition: all var(--duration-normal) var(--ease-standard); text-align: center; width: 100%; margin-bottom: var(--space-12); }
.btn-primary { background-color: var(--color-primary); color: var(--color-btn-primary-text); }
.btn-primary:hover { background-color: var(--color-primary-hover); }
.btn-secondary { background-color: var(--color-secondary); color: var(--color-text); }
.btn-secondary:hover { background-color: var(--color-secondary-hover); }
.btn-danger { background-color: var(--color-error); color: var(--color-white); }
.btn-danger:hover { opacity: 0.9; }

/* ===== MODIFICATIONS DEMANDÃ‰ES ===== */
.btn-create-program { 
    font-size: 18px; 
    padding: 16px 24px;
    font-weight: 600;
}

.btn-sync { 
    background-color: var(--color-purple-500); 
    color: var(--color-btn-primary-text); 
}
.btn-sync:hover { 
    background-color: var(--color-purple-600); 
}
/* ===== FIN MODIFICATIONS ===== */

.form-group { margin-bottom: var(--space-20); }
label { display: block; margin-bottom: var(--space-8); font-weight: var(--font-weight-medium); font-size: var(--font-size-base); }
input, select, textarea { width: 100%; padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); font-size: var(--font-size-base); background-color: var(--color-surface); color: var(--color-text); font-family: var(--font-family-base); }
select { appearance: none; background-image: var(--select-caret-light); background-repeat: no-repeat; background-position: left var(--space-12) center; background-size: 16px; padding-left: var(--space-32); }
@media (prefers-color-scheme: dark) { select { background-image: var(--select-caret-dark); } }
input:focus, select:focus, textarea:focus { outline: var(--focus-outline); border-color: var(--color-primary); }
.task-card { background-color: var(--color-bg-1); border: 1px solid var(--color-card-border); border-radius: var(--radius-lg); padding: var(--space-20); margin-bottom: var(--space-16); }
.task-card.completed { background-color: var(--color-bg-3); opacity: 0.8; }
.task-card.delayed { background-color: var(--color-bg-4); }
.task-card.future { background-color: var(--color-bg-2); opacity: 0.7; }
.task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-12); }
.task-info { font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); }
.task-range { font-size: var(--font-size-base); color: var(--color-text-secondary); margin-top: var(--space-8); }
.status-badge { display: inline-block; padding: var(--space-6) var(--space-12); border-radius: var(--radius-full); font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); }
.status-success { background-color: rgba(var(--color-success-rgb), var(--status-bg-opacity)); color: var(--color-success); border: 1px solid rgba(var(--color-success-rgb), var(--status-border-opacity)); }
.status-warning { background-color: rgba(var(--color-warning-rgb), var(--status-bg-opacity)); color: var(--color-warning); border: 1px solid rgba(var(--color-warning-rgb), var(--status-border-opacity)); }
.status-error { background-color: rgba(var(--color-error-rgb), var(--status-bg-opacity)); color: var(--color-error); border: 1px solid rgba(var(--color-error-rgb), var(--status-border-opacity)); }
.status-info { background-color: rgba(var(--color-info-rgb), var(--status-bg-opacity)); color: var(--color-info); border: 1px solid rgba(var(--color-info-rgb), var(--status-border-opacity)); }
.hidden { display: none; }
.checkbox-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--space-12); }
.checkbox-label { display: flex; align-items: center; gap: var(--space-8); cursor: pointer; }
.checkbox-label input { width: auto; cursor: pointer; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-16); margin-bottom: var(--space-24); }
.stat-item { background-color: var(--color-bg-5); padding: var(--space-16); border-radius: var(--radius-base); text-align: center; border: 1px solid var(--color-card-border); }
.stat-value { font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary); display: block; }
.stat-label { font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-4); }
.tabs { display: flex; gap: var(--space-8); margin-bottom: var(--space-20); border-bottom: 2px solid var(--color-border); }
.tab { padding: var(--space-12) var(--space-20); background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-size: var(--font-size-base); font-weight: var(--font-weight-medium); color: var(--color-text-secondary); transition: all var(--duration-fast) var(--ease-standard); }
.tab.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
.tab:hover { color: var(--color-primary-hover); }
.progress-bar { width: 100%; height: 24px; background-color: var(--color-secondary); border-radius: var(--radius-full); overflow: hidden; margin: var(--space-16) 0; }
.progress-fill { height: 100%; background-color: var(--color-primary); transition: width var(--duration-normal) var(--ease-standard); display: flex; align-items: center; justify-content: center; color: var(--color-btn-primary-text); font-size: var(--font-size-sm); font-weight: var(--font-weight-bold); }
.btn-group { display: flex; gap: var(--space-12); margin-top: var(--space-16); }
.btn-group .btn { margin-bottom: 0; }
.alert { padding: var(--space-16); border-radius: var(--radius-base); margin-bottom: var(--space-16); border: 1px solid; }
.alert-info { background-color: var(--color-bg-1); border-color: var(--color-primary); color: var(--color-text); }
.alert-warning { background-color: var(--color-bg-4); border-color: var(--color-error); color: var(--color-text); }
.partial-progress { background-color: var(--color-bg-6); padding: var(--space-16); border-radius: var(--radius-base); margin-top: var(--space-16); border: 1px solid var(--color-card-border); }
.verse-input-group { display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-12); }
.small-text { font-size: var(--font-size-sm); color: var(--color-text-secondary); }
.task-number { background-color: var(--color-primary); color: var(--color-btn-primary-text); width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: var(--font-weight-bold); font-size: var(--font-size-sm); margin-left: var(--space-8); }
.task-actions { display: flex; gap: var(--space-8); margin-top: var(--space-12); }
.btn-small { padding: var(--space-6) var(--space-12); font-size: var(--font-size-sm); }
.program-list-item { background-color: var(--color-bg-2); border: 1px solid var(--color-card-border); border-radius: var(--radius-base); padding: var(--space-16); margin-bottom: var(--space-12); cursor: pointer; transition: all var(--duration-fast) var(--ease-standard); }
.program-list-item:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
.program-title { font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-8); }
.program-meta { font-size: var(--font-size-sm); color: var(--color-text-secondary); }
.sync-indicator { position: fixed; bottom: 20px; left: 20px; background: var(--color-success); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; opacity: 0; transition: opacity 0.3s; z-index: 1000; }
.sync-indicator.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“– Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1>
        </div>

        <div id="syncStatus" class="sync-indicator">â˜ï¸ Ù…Ø­ÙÙˆØ¸</div>

        <!-- Login/Register View -->
        <div id="authView" class="card">
            <h2 style="margin-bottom: var(--space-20);">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
            
            <div class="form-group">
                <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input type="email" id="authEmail" placeholder="example@email.com">
            </div>
            
            <div class="form-group">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="rememberMe" checked>
                    ØªØ°ÙƒØ± Ø¨ÙŠØ§Ù†Ø§ØªÙŠ
                </label>
            </div>
            
            <button class="btn btn-primary" onclick="loginUser()">ğŸ”“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            <button class="btn btn-secondary" onclick="registerUser()">âœï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            <button class="btn btn-secondary" onclick="skipAuth()">â­ï¸ Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨</button>
        </div>

        <div id="menuView" class="card">
            <div id="userInfo" style="margin-bottom: var(--space-16); padding: var(--space-12); background: var(--color-bg-5); border-radius: var(--radius-base);"></div>
            
            <button class="btn btn-primary btn-create-program" onclick="showCreateProgramView()">â• Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¬Ø¯ÙŠØ¯</button>
            <button class="btn btn-secondary" onclick="showProgramsList()">ğŸ“‹ Ø¨Ø±Ø§Ù…Ø¬ÙŠ</button>
            
            <div style="margin-top: var(--space-20); padding-top: var(--space-20); border-top: 1px solid var(--color-border);">
                <h3 style="margin-bottom: var(--space-12); font-size: var(--font-size-lg);">ğŸ“¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                <button class="btn btn-sync" onclick="manualSync()" id="syncButton">ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© ÙŠØ¯ÙˆÙŠØ©</button>
                <button class="btn btn-secondary" onclick="exportData()">ğŸ’¾ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
                <button class="btn btn-secondary" onclick="importData()">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(event)">
            </div>
        </div>

        <div id="programsListView" class="hidden">
            <button class="btn btn-secondary" onclick="showMenuView()">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
            <div class="card">
                <h2 style="margin-bottom: var(--space-20);">ğŸ“‹ Ø¨Ø±Ø§Ù…Ø¬ÙŠ</h2>
                <div id="programsList"></div>
            </div>
        </div>

        <div id="createProgramView" class="card hidden">
            <h2 style="margin-bottom: var(--space-20);">Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¬Ø¯ÙŠØ¯</h2>

            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
                <input type="text" id="programName" placeholder="Ù…Ø«Ø§Ù„: Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù…">
            </div>

            <div class="form-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
                <select id="programType">
                    <option value="lecture">ğŸ“– Ù‚Ø±Ø§Ø¡Ø©</option>
                    <option value="memorisation">ğŸ§  Ø­ÙØ¸</option>
                    <option value="revision">ğŸ”„ Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                </select>
            </div>

            <div class="form-group">
                <label>Ù…Ù† (Ø³ÙˆØ±Ø©:Ø¢ÙŠØ©)</label>
                <div class="verse-input-group">
                    <select id="startSurah"></select>
                    <input type="number" id="startVerse" min="1" placeholder="Ø§Ù„Ø¢ÙŠØ©">
                </div>
            </div>

            <div class="form-group">
                <label>Ø¥Ù„Ù‰ (Ø³ÙˆØ±Ø©:Ø¢ÙŠØ©)</label>
                <div class="verse-input-group">
                    <select id="endSurah"></select>
                    <input type="number" id="endVerse" min="1" placeholder="Ø§Ù„Ø¢ÙŠØ©">
                </div>
            </div>

            <div class="form-group">
                <label>ğŸ“† Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
                <input type="number" id="numberOfDays" min="1" value="30" placeholder="Ù…Ø«Ø§Ù„: 30 ÙŠÙˆÙ…">
                <small class="small-text" style="display: block; margin-top: var(--space-4);">Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</small>
            </div>

            <div class="form-group">
                <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨ ÙŠÙˆÙ…ÙŠØ§Ù‹</label>
                <input type="text" id="calculatedVersesPerDay" readonly style="background-color: var(--color-secondary);" value="Ø³ÙŠØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
            </div>

            <div class="form-group">
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
                <input type="date" id="startDate">
            </div>

            <div class="form-group">
                <label>Ø£ÙŠØ§Ù… Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡ (Ù„Ù† ØªØ­Ø³Ø¨ ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬)</label>
                <div class="checkbox-group" id="excludedDaysGroup"></div>
            </div>

            <div class="form-group">
                <label>ÙˆÙ‚Øª Ø§Ù„ØªØ°ÙƒÙŠØ±</label>
                <input type="time" id="reminderTime" value="09:00">
            </div>

            <button class="btn btn-primary" onclick="createProgram()">âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</button>
            <button class="btn btn-secondary" onclick="showMenuView()">âŒ Ø¥Ù„ØºØ§Ø¡</button>
        </div>

        <div id="mainView" class="hidden">
            <button class="btn btn-secondary" onclick="showMenuView()">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>

            <div class="card">
                <h2 id="programTitle" style="margin-bottom: var(--space-16);"></h2>

                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="totalVersesDisplay">0</span>
                        <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¢ÙŠØ§Øª</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="completedVersesDisplay">0</span>
                        <span class="stat-label">Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="remainingVersesDisplay">0</span>
                        <span class="stat-label">Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="streakDisplay">0</span>
                        <span class="stat-label">Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø£ÙŠØ§Ù…</span>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>

                <div id="todayTaskCard"></div>
                <div id="delayAlert"></div>
                <div id="partialProgressAlert"></div>

                <div class="btn-group">
                    <button class="btn btn-danger" onclick="deleteCurrentProgram()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</button>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: var(--space-16);">ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ù…Ù‡Ø§Ù…</h3>

                <div class="tabs">
                    <button class="tab active" onclick="showAllScheduledTasks()">ğŸ“… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©</button>
                    <button class="tab" onclick="showCompletedHistory()">âœ… Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</button>
                    <button class="tab" onclick="showPendingHistory()">â³ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</button>
                </div>

                <div id="historyContent"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyApUV95mV7_YC29KKxdLcjlddf564PJeeg",
            authDomain: "quran-s-agenda.firebaseapp.com",
            projectId: "quran-s-agenda",
            storageBucket: "quran-s-agenda.firebasestorage.app",
            messagingSenderId: "771795458928",
            appId: "1:771795458928:web:3dbf37f776d7ca2e544db5",
            measurementId: "G-33HN1TPBFX"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.firebaseDB = db;
        window.firebaseAuth = auth;
        window.firestoreDoc = doc;
        window.firestoreSetDoc = setDoc;
        window.firestoreGetDoc = getDoc;
        window.firebaseCreateUser = createUserWithEmailAndPassword;
        window.firebaseSignIn = signInWithEmailAndPassword;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        window.firebaseSignOut = signOut;

        console.log('âœ… Firebase initialisÃ© avec succÃ¨s');
        
        // ===== SETUP AUTH STATE LISTENER BEFORE INIT =====
        let authInitialized = false;
        window.firebaseOnAuthStateChanged(window.firebaseAuth, async (user) => {
            if (user) {
                currentUser = user;
                isCloudSyncEnabled = true;
                console.log('âœ… User already logged in:', user.email);
                
                const cloudLoaded = await loadFromCloud();
                if (!cloudLoaded) {
                    loadFromStorage();
                }
                
                updateUserInfo();
                localStorage.setItem('quranAppVisited', 'true');
            } else {
                currentUser = null;
                isCloudSyncEnabled = false;
                loadFromStorage();
                updateUserInfo();
            }
            authInitialized = true;
            showCorrectView();
        });

        // ===== REGISTER SERVICE WORKER =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('âœ… Service Worker enregistrÃ©:', registration);
                    })
                    .catch(error => {
                        console.error('âŒ Erreur Service Worker:', error);
                    });
            });
        }
    </script>

    <script>
// ====================================
// ANTI-REFRESH & ANTI-SLEEP SYSTEM
// ====================================

document.addEventListener('touchmove', function(e) {
    if (window.scrollY === 0) {
        e.preventDefault();
    }
}, { passive: false });

document.addEventListener('keydown', function(e) {
    if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
        if (!confirm('âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØ¹Ù„Ø§Ù‹ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©ØŸ Ù‚Ø¯ ØªÙÙ‚Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©!')) {
            e.preventDefault();
            return false;
        }
    }
});

let wakeLock = null;

async function enableWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('âœ… Wake Lock activÃ© - l\'Ã©cran restera allumÃ©');
            
            wakeLock.addEventListener('release', () => {
                console.log('âš ï¸ Wake Lock relÃ¢chÃ©');
            });
        }
    } catch (err) {
        console.warn('âŒ Wake Lock non supportÃ© ou refusÃ©:', err);
    }
}

document.addEventListener('visibilitychange', async () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
        await enableWakeLock();
    }
});

enableWakeLock();

// ====================================
// SURAH DATA
// ====================================

const SURAH_DATA = [
    {num: 1, name: "Ø§Ù„ÙØ§ØªØ­Ø©", verses: 7}, {num: 2, name: "Ø§Ù„Ø¨Ù‚Ø±Ø©", verses: 286}, {num: 3, name: "Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", verses: 200}, {num: 4, name: "Ø§Ù„Ù†Ø³Ø§Ø¡", verses: 176}, {num: 5, name: "Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©", verses: 120}, {num: 6, name: "Ø§Ù„Ø£Ù†Ø¹Ø§Ù…", verses: 165}, {num: 7, name: "Ø§Ù„Ø£Ø¹Ø±Ø§Ù", verses: 206}, {num: 8, name: "Ø§Ù„Ø£Ù†ÙØ§Ù„", verses: 75}, {num: 9, name: "Ø§Ù„ØªÙˆØ¨Ø©", verses: 129}, {num: 10, name: "ÙŠÙˆÙ†Ø³", verses: 109}, {num: 11, name: "Ù‡ÙˆØ¯", verses: 123}, {num: 12, name: "ÙŠÙˆØ³Ù", verses: 111}, {num: 13, name: "Ø§Ù„Ø±Ø¹Ø¯", verses: 43}, {num: 14, name: "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…", verses: 52}, {num: 15, name: "Ø§Ù„Ø­Ø¬Ø±", verses: 99}, {num: 16, name: "Ø§Ù„Ù†Ø­Ù„", verses: 128}, {num: 17, name: "Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡", verses: 111}, {num: 18, name: "Ø§Ù„ÙƒÙ‡Ù", verses: 110}, {num: 19, name: "Ù…Ø±ÙŠÙ…", verses: 98}, {num: 20, name: "Ø·Ù‡", verses: 135}, {num: 21, name: "Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡", verses: 112}, {num: 22, name: "Ø§Ù„Ø­Ø¬", verses: 78}, {num: 23, name: "Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†", verses: 118}, {num: 24, name: "Ø§Ù„Ù†ÙˆØ±", verses: 64}, {num: 25, name: "Ø§Ù„ÙØ±Ù‚Ø§Ù†", verses: 77}, {num: 26, name: "Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡", verses: 227}, {num: 27, name: "Ø§Ù„Ù†Ù…Ù„", verses: 93}, {num: 28, name: "Ø§Ù„Ù‚ØµØµ", verses: 88}, {num: 29, name: "Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª", verses: 69}, {num: 30, name: "Ø§Ù„Ø±ÙˆÙ…", verses: 60}, {num: 31, name: "Ù„Ù‚Ù…Ø§Ù†", verses: 34}, {num: 32, name: "Ø§Ù„Ø³Ø¬Ø¯Ø©", verses: 30}, {num: 33, name: "Ø§Ù„Ø£Ø­Ø²Ø§Ø¨", verses: 73}, {num: 34, name: "Ø³Ø¨Ø£", verses: 54}, {num: 35, name: "ÙØ§Ø·Ø±", verses: 45}, {num: 36, name: "ÙŠØ³", verses: 83}, {num: 37, name: "Ø§Ù„ØµØ§ÙØ§Øª", verses: 182}, {num: 38, name: "Øµ", verses: 88}, {num: 39, name: "Ø§Ù„Ø²Ù…Ø±", verses: 75}, {num: 40, name: "ØºØ§ÙØ±", verses: 85}, {num: 41, name: "ÙØµÙ„Øª", verses: 54}, {num: 42, name: "Ø§Ù„Ø´ÙˆØ±Ù‰", verses: 53}, {num: 43, name: "Ø§Ù„Ø²Ø®Ø±Ù", verses: 89}, {num: 44, name: "Ø§Ù„Ø¯Ø®Ø§Ù†", verses: 59}, {num: 45, name: "Ø§Ù„Ø¬Ø§Ø«ÙŠØ©", verses: 37}, {num: 46, name: "Ø§Ù„Ø£Ø­Ù‚Ø§Ù", verses: 35}, {num: 47, name: "Ù…Ø­Ù…Ø¯", verses: 38}, {num: 48, name: "Ø§Ù„ÙØªØ­", verses: 29}, {num: 49, name: "Ø§Ù„Ø­Ø¬Ø±Ø§Øª", verses: 18}, {num: 50, name: "Ù‚", verses: 45}, {num: 51, name: "Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª", verses: 60}, {num: 52, name: "Ø§Ù„Ø·ÙˆØ±", verses: 49}, {num: 53, name: "Ø§Ù„Ù†Ø¬Ù…", verses: 62}, {num: 54, name: "Ø§Ù„Ù‚Ù…Ø±", verses: 55}, {num: 55, name: "Ø§Ù„Ø±Ø­Ù…Ù†", verses: 78}, {num: 56, name: "Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©", verses: 96}, {num: 57, name: "Ø§Ù„Ø­Ø¯ÙŠØ¯", verses: 29}, {num: 58, name: "Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©", verses: 22}, {num: 59, name: "Ø§Ù„Ø­Ø´Ø±", verses: 24}, {num: 60, name: "Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©", verses: 13}, {num: 61, name: "Ø§Ù„ØµÙ", verses: 14}, {num: 62, name: "Ø§Ù„Ø¬Ù…Ø¹Ø©", verses: 11}, {num: 63, name: "Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†", verses: 11}, {num: 64, name: "Ø§Ù„ØªØºØ§Ø¨Ù†", verses: 18}, {num: 65, name: "Ø§Ù„Ø·Ù„Ø§Ù‚", verses: 12}, {num: 66, name: "Ø§Ù„ØªØ­Ø±ÙŠÙ…", verses: 12}, {num: 67, name: "Ø§Ù„Ù…Ù„Ùƒ", verses: 30}, {num: 68, name: "Ø§Ù„Ù‚Ù„Ù…", verses: 52}, {num: 69, name: "Ø§Ù„Ø­Ø§Ù‚Ø©", verses: 52}, {num: 70, name: "Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬", verses: 44}, {num: 71, name: "Ù†ÙˆØ­", verses: 28}, {num: 72, name: "Ø§Ù„Ø¬Ù†", verses: 28}, {num: 73, name: "Ø§Ù„Ù…Ø²Ù…Ù„", verses: 20}, {num: 74, name: "Ø§Ù„Ù…Ø¯Ø«Ø±", verses: 56}, {num: 75, name: "Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", verses: 40}, {num: 76, name: "Ø§Ù„Ø¥Ù†Ø³Ø§Ù†", verses: 31}, {num: 77, name: "Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", verses: 50}, {num: 78, name: "Ø§Ù„Ù†Ø¨Ø£", verses: 40}, {num: 79, name: "Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª", verses: 46}, {num: 80, name: "Ø¹Ø¨Ø³", verses: 42}, {num: 81, name: "Ø§Ù„ØªÙƒÙˆÙŠØ±", verses: 29}, {num: 82, name: "Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±", verses: 19}, {num: 83, name: "Ø§Ù„Ù…Ø·ÙÙÙŠÙ†", verses: 36}, {num: 84, name: "Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚", verses: 25}, {num: 85, name: "Ø§Ù„Ø¨Ø±ÙˆØ¬", verses: 22}, {num: 86, name: "Ø§Ù„Ø·Ø§Ø±Ù‚", verses: 17}, {num: 87, name: "Ø§Ù„Ø£Ø¹Ù„Ù‰", verses: 19}, {num: 88, name: "Ø§Ù„ØºØ§Ø´ÙŠØ©", verses: 26}, {num: 89, name: "Ø§Ù„ÙØ¬Ø±", verses: 30}, {num: 90, name: "Ø§Ù„Ø¨Ù„Ø¯", verses: 20}, {num: 91, name: "Ø§Ù„Ø´Ù…Ø³", verses: 15}, {num: 92, name: "Ø§Ù„Ù„ÙŠÙ„", verses: 21}, {num: 93, name: "Ø§Ù„Ø¶Ø­Ù‰", verses: 11}, {num: 94, name: "Ø§Ù„Ø´Ø±Ø­", verses: 8}, {num: 95, name: "Ø§Ù„ØªÙŠÙ†", verses: 8}, {num: 96, name: "Ø§Ù„Ø¹Ù„Ù‚", verses: 19}, {num: 97, name: "Ø§Ù„Ù‚Ø¯Ø±", verses: 5}, {num: 98, name: "Ø§Ù„Ø¨ÙŠÙ†Ø©", verses: 8}, {num: 99, name: "Ø§Ù„Ø²Ù„Ø²Ù„Ø©", verses: 8}, {num: 100, name: "Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª", verses: 11}, {num: 101, name: "Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©", verses: 11}, {num: 102, name: "Ø§Ù„ØªÙƒØ§Ø«Ø±", verses: 8}, {num: 103, name: "Ø§Ù„Ø¹ØµØ±", verses: 3}, {num: 104, name: "Ø§Ù„Ù‡Ù…Ø²Ø©", verses: 9}, {num: 105, name: "Ø§Ù„ÙÙŠÙ„", verses: 5}, {num: 106, name: "Ù‚Ø±ÙŠØ´", verses: 4}, {num: 107, name: "Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†", verses: 7}, {num: 108, name: "Ø§Ù„ÙƒÙˆØ«Ø±", verses: 3}, {num: 109, name: "Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†", verses: 6}, {num: 110, name: "Ø§Ù„Ù†ØµØ±", verses: 3}, {num: 111, name: "Ø§Ù„Ù…Ø³Ø¯", verses: 5}, {num: 112, name: "Ø§Ù„Ø¥Ø®Ù„Ø§Øµ", verses: 4}, {num: 113, name: "Ø§Ù„ÙÙ„Ù‚", verses: 5}, {num: 114, name: "Ø§Ù„Ù†Ø§Ø³", verses: 6}
];

const WEEKDAYS = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
const GREGORIAN_MONTHS_ARABIC = ["Ø¬Ø§Ù†ÙÙŠ", "ÙÙŠÙØ±ÙŠ", "Ù…Ø§Ø±Ø³", "Ø£ÙØ±ÙŠÙ„", "Ù…Ø§ÙŠ", "Ø¬ÙˆØ§Ù†", "Ø¬ÙˆÙŠÙ„ÙŠØ©", "Ø£ÙˆØª", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
const HIJRI_MONTHS = ["Ù…Ø­Ø±Ù…", "ØµÙØ±", "Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„", "Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø¢Ø®Ø±", "Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰", "Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø¢Ø®Ø±Ø©", "Ø±Ø¬Ø¨", "Ø´Ø¹Ø¨Ø§Ù†", "Ø±Ù…Ø¶Ø§Ù†", "Ø´ÙˆØ§Ù„", "Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©", "Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©"];
const PROGRAM_TYPES = {lecture: "ğŸ“– Ù‚Ø±Ø§Ø¡Ø©", memorisation: "ğŸ§  Ø­ÙØ¸", revision: "ğŸ”„ Ù…Ø±Ø§Ø¬Ø¹Ø©"};

let allPrograms = [];
let currentProgramId = null;
let isCloudSyncEnabled = false;
let currentUser = null;

// ====================================
// SHOW CORRECT VIEW AFTER AUTH CHECK
// ====================================

function showCorrectView() {
    const hasVisitedBefore = localStorage.getItem('quranAppVisited');
    
    if (currentUser) {
        updateUserInfo();
        showMenuView();
    } else if (hasVisitedBefore) {
        updateUserInfo();
        showMenuView();
    } else {
        showAuthView();
    }
}

// ====================================
// SYSTÃˆME DE SAUVEGARDE (localStorage + Firebase)
// ====================================

function showSyncIndicator() {
    const indicator = document.getElementById('syncStatus');
    indicator.classList.add('show');
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 2000);
}

async function saveToCloud() {
    if (!window.firebaseDB || !currentUser) return;
    
    try {
        const userId = currentUser.uid;
        const docRef = window.firestoreDoc(window.firebaseDB, 'quranPrograms', userId);
        
        await window.firestoreSetDoc(docRef, {
            programs: allPrograms,
            currentProgramId: currentProgramId,
            lastUpdated: new Date().toISOString()
        });
        
        console.log('â˜ï¸ DonnÃ©es sauvegardÃ©es dans le Cloud');
        showSyncIndicator();
    } catch (error) {
        console.error('âŒ Erreur sauvegarde Cloud:', error);
    }
}

async function loadFromCloud() {
    if (!window.firebaseDB || !currentUser) return false;
    
    try {
        const userId = currentUser.uid;
        const docRef = window.firestoreDoc(window.firebaseDB, 'quranPrograms', userId);
        const docSnap = await window.firestoreGetDoc(docRef);
        
        if (docSnap.exists()) {
            const data = docSnap.data();
            allPrograms = data.programs || [];
            currentProgramId = data.currentProgramId || null;
            isCloudSyncEnabled = true;
            console.log('â˜ï¸ DonnÃ©es chargÃ©es depuis le Cloud:', allPrograms.length, 'programmes');
            return true;
        }
        return false;
    } catch (error) {
        console.error('âŒ Erreur chargement Cloud:', error);
        return false;
    }
}

function loadFromStorage() {
    try {
        const storedPrograms = localStorage.getItem('quranPrograms');
        if (storedPrograms) {
            allPrograms = JSON.parse(storedPrograms);
            console.log('ğŸ’¾ Programmes chargÃ©s depuis localStorage:', allPrograms.length);
        }
        
        const storedCurrentId = localStorage.getItem('currentProgramId');
        if (storedCurrentId) {
            currentProgramId = storedCurrentId;
            console.log('ğŸ’¾ Programme actif chargÃ©:', currentProgramId);
        }
    } catch (error) {
        console.error('âŒ Erreur lors du chargement:', error);
        allPrograms = [];
        currentProgramId = null;
    }
}

function saveToStorage() {
    try {
        localStorage.setItem('quranPrograms', JSON.stringify(allPrograms));
        
        if (currentProgramId) {
            localStorage.setItem('currentProgramId', currentProgramId);
        } else {
            localStorage.removeItem('currentProgramId');
        }
        
        console.log('ğŸ’¾ DonnÃ©es sauvegardÃ©es en local');
        
        if (currentUser && isCloudSyncEnabled) {
            saveToCloud();
        }
    } catch (error) {
        console.error('âŒ Erreur lors de la sauvegarde:', error);
        alert('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø§Ø­Ø© ÙƒØ§ÙÙŠØ© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.');
    }
}

// ====================================
// INIT
// ====================================

function init() {
    populateSurahSelects();
    populateExcludedDays();
    setDefaultStartDate();
    setupCalculatorListeners();
    loadSavedCredentials();
}

function loadSavedCredentials() {
    const savedCreds = getSavedCredentials();
    if (savedCreds) {
        document.getElementById('authEmail').value = savedCreds.email;
        document.getElementById('authPassword').value = savedCreds.password;
        document.getElementById('rememberMe').checked = true;
    }
}

function getSavedCredentials() {
    try {
        const saved = localStorage.getItem('quranAgendaAuth');
        return saved ? JSON.parse(saved) : null;
    } catch (e) {
        return null;
    }
}

function saveCredentials(email, password) {
    const rememberMe = document.getElementById('rememberMe').checked;
    if (rememberMe) {
        localStorage.setItem('quranAgendaAuth', JSON.stringify({ email, password }));
    } else {
        localStorage.removeItem('quranAgendaAuth');
    }
}

function clearSavedCredentials() {
    localStorage.removeItem('quranAgendaAuth');
}

function showAuthView() {
    hideAllViews();
    document.getElementById('authView').classList.remove('hidden');
}

function updateUserInfo() {
    const userInfoDiv = document.getElementById('userInfo');
    if (currentUser) {
        userInfoDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>ğŸ‘¤ ${currentUser.email}</strong><br>
                    <small style="color: var(--color-text-secondary);">â˜ï¸ Ù…ØªØµÙ„ - Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</small>
                </div>
                <button class="btn btn-secondary btn-small" onclick="logoutUser()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        `;
    } else {
        userInfoDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>ğŸ’¾ ÙˆØ¶Ø¹ Ù…Ø­Ù„ÙŠ</strong><br>
                    <small style="color: var(--color-text-secondary);">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·</small>
                </div>
                <button class="btn btn-secondary btn-small" onclick="showAuthView()">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
        `;
    }
}

async function registerUser() {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    
    if (!email || !password) {
        alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
        return;
    }
    
    if (password.length < 6) {
        alert('âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
        return;
    }
    
    try {
        const userCredential = await window.firebaseCreateUser(window.firebaseAuth, email, password);
        currentUser = userCredential.user;
        isCloudSyncEnabled = true;
        
        saveCredentials(email, password);
        localStorage.setItem('quranAppVisited', 'true');
        loadFromStorage();
        await saveToCloud();
        
        updateUserInfo();
        showMenuView();
    } catch (error) {
        console.error('Error:', error);
        if (error.code === 'auth/email-already-in-use') {
            alert('âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„');
        } else if (error.code === 'auth/invalid-email') {
            alert('âš ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­');
        } else if (error.code === 'auth/weak-password') {
            alert('âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹');
        } else {
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: ' + error.message);
        }
    }
}

async function loginUser() {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    
    if (!email || !password) {
        const savedCreds = getSavedCredentials();
        if (!savedCreds) {
            showAuthView();
            alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
            return;
        }
    }
    
    try {
        const userCredential = await window.firebaseSignIn(window.firebaseAuth, email, password);
        currentUser = userCredential.user;
        isCloudSyncEnabled = true;
        
        saveCredentials(email, password);
        localStorage.setItem('quranAppVisited', 'true');
        
        const cloudLoaded = await loadFromCloud();
        if (cloudLoaded) {
            saveToStorage();
        } else {
            loadFromStorage();
        }
        
        updateUserInfo();
        showMenuView();
    } catch (error) {
        console.error('Error:', error);
        showAuthView();
        
        if (error.code === 'auth/user-not-found') {
            alert('âš ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        } else if (error.code === 'auth/wrong-password') {
            alert('âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
        } else if (error.code === 'auth/invalid-email') {
            alert('âš ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­');
        } else if (error.code === 'auth/invalid-credential') {
            alert('âš ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
        } else {
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message);
        }
    }
}

async function logoutUser() {
    if (confirm('âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        try {
            await window.firebaseSignOut(window.firebaseAuth);
            clearSavedCredentials();
            currentUser = null;
            isCloudSyncEnabled = false;
            updateUserInfo();
            alert('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
            showAuthView();
        } catch (error) {
            console.error('Error:', error);
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
        }
    }
}

async function manualSync() {
    const button = document.getElementById('syncButton');
    const originalText = button.textContent;
    
    if (!currentUser) {
        alert('âš ï¸ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
        return;
    }
    
    button.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...';
    button.disabled = true;
    
    try {
        await saveToCloud();
        
        const cloudLoaded = await loadFromCloud();
        if (cloudLoaded) {
            saveToStorage();
            updateMainView();
        }
        
        showSyncIndicator();
        alert('âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­!');
    } catch (error) {
        console.error('Error:', error);
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ' + error.message);
    } finally {
        button.textContent = originalText;
        button.disabled = false;
    }
}

function skipAuth() {
    currentUser = null;
    isCloudSyncEnabled = false;
    localStorage.setItem('quranAppVisited', 'true');
    loadFromStorage();
    updateUserInfo();
    showMenuView();
}

function exportData() {
    const data = {
        programs: allPrograms,
        currentProgramId: currentProgramId,
        exportDate: new Date().toISOString(),
        version: '1.0'
    };
    
    const jsonString = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'quran-agenda-backup-' + new Date().toISOString().split('T')[0] + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
}

function importData() {
    document.getElementById('importFile').click();
}

function handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            if (!data.programs || !Array.isArray(data.programs)) {
                alert('âš ï¸ Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­');
                return;
            }
            
            if (confirm('âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
                allPrograms = data.programs;
                currentProgramId = data.currentProgramId || null;
                
                saveToStorage();
                
                if (currentUser) {
                    saveToCloud();
                }
                
                alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                
                if (currentProgramId && getCurrentProgram()) {
                    showMainView();
                } else {
                    showMenuView();
                }
            }
        } catch (error) {
            console.error('Error:', error);
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù');
        }
    };
    
    reader.readAsText(file);
    event.target.value = '';
}

// ====================================
// FUNCTIONS FOR PROGRAM CREATION
// ====================================

function setupCalculatorListeners() {
    const startSurah = document.getElementById('startSurah');
    const startVerse = document.getElementById('startVerse');
    const endSurah = document.getElementById('endSurah');
    const endVerse = document.getElementById('endVerse');
    const numberOfDays = document.getElementById('numberOfDays');
    
    const calculate = () => {
        const ss = parseInt(startSurah.value);
        const sv = parseInt(startVerse.value) || 1;
        const es = parseInt(endSurah.value);
        const ev = parseInt(endVerse.value) || SURAH_DATA[es - 1].verses;
        const days = parseInt(numberOfDays.value) || 1;
        
        if (ss && sv && es && ev && days > 0) {
            const total = calculateTotalVerses(ss, sv, es, ev);
            if (total > 0) {
                const versesPerDay = Math.ceil(total / days);
                document.getElementById('calculatedVersesPerDay').value = versesPerDay + ' Ø¢ÙŠØ© ÙŠÙˆÙ…ÙŠØ§Ù‹ (Ø¥Ø¬Ù…Ø§Ù„ÙŠ ' + total + ' Ø¢ÙŠØ©)';
            }
        }
    };
    
    startSurah.addEventListener('change', calculate);
    startVerse.addEventListener('input', calculate);
    endSurah.addEventListener('change', calculate);
    endVerse.addEventListener('input', calculate);
    numberOfDays.addEventListener('input', calculate);
}

function validateVerseInput(input, surahNum) {
    const maxVerses = SURAH_DATA[surahNum - 1].verses;
    const value = parseInt(input.value);
    
    input.style.border = '';
    input.style.backgroundColor = '';
    
    if (value < 1 || value > maxVerses) {
        input.style.border = '2px solid #ff0000';
        input.style.backgroundColor = '#ffe6e6';
        
        setTimeout(() => {
            alert('âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 1 Ùˆ ' + maxVerses + ' Ù„Ø³ÙˆØ±Ø© ' + SURAH_DATA[surahNum - 1].name);
            input.value = maxVerses;
            input.style.border = '';
            input.style.backgroundColor = '';
        }, 100);
        
        return false;
    }
    
    return true;
}

function populateSurahSelects() {
    const startSelect = document.getElementById('startSurah');
    const endSelect = document.getElementById('endSurah');
    const startVerse = document.getElementById('startVerse');
    const endVerse = document.getElementById('endVerse');
    
    SURAH_DATA.forEach(surah => {
        const option1 = document.createElement('option');
        option1.value = surah.num;
        option1.textContent = surah.num + '. ' + surah.name + ' (' + surah.verses + ' Ø¢ÙŠØ©)';
        startSelect.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = surah.num;
        option2.textContent = surah.num + '. ' + surah.name + ' (' + surah.verses + ' Ø¢ÙŠØ©)';
        endSelect.appendChild(option2);
    });
    
    startSelect.value = '1';
    endSelect.value = '114';
    startVerse.value = '1';
    endVerse.value = '6';
    
    startSelect.addEventListener('change', function() {
        const surahNum = parseInt(this.value);
        const maxVerses = SURAH_DATA[surahNum - 1].verses;
        
        startVerse.value = '1';
        startVerse.max = maxVerses;
        startVerse.placeholder = '1 - ' + maxVerses;
    });
    
    endSelect.addEventListener('change', function() {
        const surahNum = parseInt(this.value);
        const maxVerses = SURAH_DATA[surahNum - 1].verses;
        
        endVerse.value = maxVerses;
        endVerse.max = maxVerses;
        endVerse.placeholder = '1 - ' + maxVerses;
    });
    
    startVerse.addEventListener('blur', function() {
        const surahNum = parseInt(startSelect.value);
        validateVerseInput(this, surahNum);
    });
    
    endVerse.addEventListener('blur', function() {
        const surahNum = parseInt(endSelect.value);
        validateVerseInput(this, surahNum);
    });
}

function populateExcludedDays() {
    const container = document.getElementById('excludedDaysGroup');
    WEEKDAYS.forEach((day, index) => {
        const label = document.createElement('label');
        label.className = 'checkbox-label';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = index;
        checkbox.id = 'day' + index;
        
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(day));
        container.appendChild(label);
    });
}

function setDefaultStartDate() {
    const today = new Date();
    const dateStr = today.toISOString().split('T')[0];
    document.getElementById('startDate').value = dateStr;
}

function showMenuView() {
    hideAllViews();
    document.getElementById('menuView').classList.remove('hidden');
}

function showCreateProgramView() {
    hideAllViews();
    document.getElementById('createProgramView').classList.remove('hidden');
}

function showProgramsList() {
    hideAllViews();
    document.getElementById('programsListView').classList.remove('hidden');
    renderProgramsList();
}

function showMainView() {
    hideAllViews();
    document.getElementById('mainView').classList.remove('hidden');
    updateMainView();
}

function hideAllViews() {
    document.getElementById('authView').classList.add('hidden');
    document.getElementById('menuView').classList.add('hidden');
    document.getElementById('createProgramView').classList.add('hidden');
    document.getElementById('programsListView').classList.add('hidden');
    document.getElementById('mainView').classList.add('hidden');
}

function createProgram() {
    const name = document.getElementById('programName').value.trim();
    const type = document.getElementById('programType').value;
    const startSurah = parseInt(document.getElementById('startSurah').value);
    const startVerse = parseInt(document.getElementById('startVerse').value);
    const endSurah = parseInt(document.getElementById('endSurah').value);
    const endVerse = parseInt(document.getElementById('endVerse').value);
    const numberOfDays = parseInt(document.getElementById('numberOfDays').value);
    const startDate = document.getElementById('startDate').value;
    const reminderTime = document.getElementById('reminderTime').value;
    
    if (!name) {
        alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬');
        return;
    }
    
    if (!startVerse || !endVerse) {
        alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¢ÙŠØ§Øª');
        return;
    }
    
    if (startVerse < 1 || startVerse > SURAH_DATA[startSurah - 1].verses) {
        alert('âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 1 Ùˆ ' + SURAH_DATA[startSurah - 1].verses + ' Ù„Ø³ÙˆØ±Ø© ' + SURAH_DATA[startSurah - 1].name);
        return;
    }
    
    if (endVerse < 1 || endVerse > SURAH_DATA[endSurah - 1].verses) {
        alert('âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 1 Ùˆ ' + SURAH_DATA[endSurah - 1].verses + ' Ù„Ø³ÙˆØ±Ø© ' + SURAH_DATA[endSurah - 1].name);
        return;
    }
    
    if (numberOfDays < 1) {
        alert('âš ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† 0');
        return;
    }
    
    const excludedDays = [];
    for (let i = 0; i < 7; i++) {
        if (document.getElementById('day' + i).checked) {
            excludedDays.push(i);
        }
    }
    
    const totalVerses = calculateTotalVerses(startSurah, startVerse, endSurah, endVerse);
    
    if (totalVerses <= 0) {
        alert('âš ï¸ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¢ÙŠØ§Øª ØºÙŠØ± ØµØ­ÙŠØ­');
        return;
    }
    
    const versesPerDay = Math.ceil(totalVerses / numberOfDays);
    const endDate = calculateEndDate(new Date(startDate), numberOfDays, excludedDays);
    
    const program = {
        id: 'prog_' + Date.now(),
        name: name,
        type: type,
        startSurah: startSurah,
        startVerse: startVerse,
        endSurah: endSurah,
        endVerse: endVerse,
        totalVerses: totalVerses,
        versesPerDay: versesPerDay,
        totalDays: numberOfDays,
        startDate: startDate,
        endDate: endDate.toISOString().split('T')[0],
        excludedDays: excludedDays,
        reminderTime: reminderTime,
        completedDays: [],
        missedDays: [],
        currentVerse: { surah: startSurah, verse: startVerse },
        streak: 0,
        lastCompletedDate: null,
        completionHistory: {},
        taskHistory: [],
        partialProgress: null,
        lastHistoryView: 'scheduled'
    };
    
    allPrograms.push(program);
    currentProgramId = program.id;
    saveToStorage();
    
    alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­!');
    showMainView();
}

function calculateTotalVerses(startS, startV, endS, endV) {
    if (startS < 1 || startS > 114 || endS < 1 || endS > 114) return 0;
    if (startS > endS) return 0;
    
    let total = 0;
    
    if (startS === endS) {
        if (endV < startV) return 0;
        return endV - startV + 1;
    }
    
    const firstSurahVerses = SURAH_DATA[startS - 1].verses;
    total += firstSurahVerses - startV + 1;
    
    for (let i = startS + 1; i < endS; i++) {
        total += SURAH_DATA[i - 1].verses;
    }
    
    total += endV;
    return total;
}

function calculateEndDate(startDate, daysNeeded, excludedDays) {
    const date = new Date(startDate);
    let count = 0;
    
    while (count < daysNeeded) {
        if (!excludedDays.includes(date.getDay())) {
            count++;
        }
        if (count < daysNeeded) {
            date.setDate(date.getDate() + 1);
        }
    }
    
    return date;
}

function isExcludedDay(date, excludedDaysSet) {
    return excludedDaysSet.has(date.getDay());
}

function renderProgramsList() {
    const container = document.getElementById('programsList');
    
    if (allPrograms.length === 0) {
        container.innerHTML = '<p class="small-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø±Ø§Ù…Ø¬ Ø¨Ø¹Ø¯. Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¬Ø¯ÙŠØ¯!</p>';
        return;
    }
    
    container.innerHTML = '';
    allPrograms.forEach(program => {
        const div = document.createElement('div');
        div.className = 'program-list-item';
        div.onclick = () => {
            currentProgramId = program.id;
            saveToStorage();
            showMainView();
        };
        
        const totalTasks = program.totalDays || Math.ceil(program.totalVerses / program.versesPerDay);
        const progress = (program.completedDays.length / totalTasks * 100).toFixed(1);
        
        div.innerHTML = '<div class="program-title">' + PROGRAM_TYPES[program.type] + ' ' + program.name + '</div>' +
            '<div class="program-meta">ğŸ“Š Ø§Ù„ØªÙ‚Ø¯Ù…: ' + progress + '% | ' + 
            'ğŸ“… Ù…Ù† ' + SURAH_DATA[program.startSurah - 1].name + ':' + program.startVerse +
            ' Ø¥Ù„Ù‰ ' + SURAH_DATA[program.endSurah - 1].name + ':' + program.endVerse + '</div>';
        
        container.appendChild(div);
    });
}

function getCurrentProgram() {
    return allPrograms.find(p => p.id === currentProgramId);
}

function calculateCompletedVerses(program) {
    let total = 0;
    program.taskHistory.forEach(task => {
        if (task.completed) {
            total += calculateTotalVerses(task.startSurah, task.startVerse, task.endSurah, task.endVerse);
        }
    });
    return total;
}

function updateMainView() {
    const program = getCurrentProgram();
    if (!program) {
        showMenuView();
        return;
    }
    
    document.getElementById('programTitle').textContent = PROGRAM_TYPES[program.type] + ' ' + program.name;
    
    const completedVerses = calculateCompletedVerses(program);
    const remainingVerses = program.totalVerses - completedVerses;
    
    document.getElementById('totalVersesDisplay').textContent = program.totalVerses;
    document.getElementById('completedVersesDisplay').textContent = completedVerses;
    document.getElementById('remainingVersesDisplay').textContent = remainingVerses;
    document.getElementById('streakDisplay').textContent = program.streak;
    
    const progress = ((completedVerses / program.totalVerses) * 100).toFixed(1);
    const progressFill = document.getElementById('progressFill');
    progressFill.style.width = progress + '%';
    progressFill.textContent = progress + '%';
    
    renderTodayTask(program);
    renderDelayAlerts(program);
    renderPartialProgressAlert(program);
    
    if (program.lastHistoryView === 'completed') {
        showCompletedHistory();
    } else if (program.lastHistoryView === 'pending') {
        showPendingHistory();
    } else {
        showAllScheduledTasks();
    }
}

function setActiveTab(index) {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach((tab, i) => {
        if (i === index) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });
}

function renderTodayTask(program) {
    const container = document.getElementById('todayTaskCard');
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    if (program.excludedDays.includes(today.getDay())) {
        container.innerHTML = '<div class="alert alert-info">ğŸ“… Ø§Ù„ÙŠÙˆÙ… Ù…Ø³ØªØ«Ù†Ù‰ Ù…Ù† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</div>';
        return;
    }
    
    if (program.completedDays.includes(todayStr)) {
        container.innerHTML = '<div class="alert alert-info">âœ… ØªÙ… Ø¥Ù†Ø¬Ø§Ø² Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­!</div>';
        return;
    }
    
    const task = getTodayTask(program);
    
    if (!task) {
        container.innerHTML = '<div class="alert alert-info">ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ø£ØªÙ…Ù…Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„!</div>';
        return;
    }
    
    const versesCount = calculateTotalVerses(task.startSurah, task.startVerse, task.endSurah, task.endVerse);
    
    container.innerHTML = '<div class="task-card">' +
        '<div class="task-header">' +
        '<div class="task-info"><span class="task-number">' + task.taskNumber + '</span> Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ…</div>' +
        '<span class="status-badge status-info">ğŸ“… ' + formatDate(today) + '</span></div>' +
        '<div class="task-range">' +
        '<strong>Ù…Ù†:</strong> Ø³ÙˆØ±Ø© ' + task.startSurahName + ' - Ø§Ù„Ø¢ÙŠØ© ' + task.startVerse + '<br>' +
        '<strong>Ø¥Ù„Ù‰:</strong> Ø³ÙˆØ±Ø© ' + task.endSurahName + ' - Ø§Ù„Ø¢ÙŠØ© ' + task.endVerse + '<br>' +
        '<strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¢ÙŠØ§Øª:</strong> ' + versesCount + ' Ø¢ÙŠØ©</div>' +
        '<div class="btn-group">' +
        '<button class="btn btn-primary" onclick="markTaskComplete()">âœ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø©</button>' +
        '<button class="btn btn-secondary" onclick="showPartialProgressForm()">ğŸ’¾ Ø­ÙØ¸ ØªÙ‚Ø¯Ù… Ø¬Ø²Ø¦ÙŠ</button></div>' +
        '<div id="partialProgressForm" class="hidden partial-progress">' +
        '<h4 style="margin-bottom: var(--space-12);">Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬Ø²Ø¦ÙŠ</h4>' +
        '<div class="form-group"><label>ØªÙˆÙ‚ÙØª Ø¹Ù†Ø¯ Ø³ÙˆØ±Ø©:Ø¢ÙŠØ©</label>' +
        '<div class="verse-input-group">' +
        '<select id="partialSurah">' + SURAH_DATA.map(s => '<option value="' + s.num + '">' + s.name + '</option>').join('') + '</select>' +
        '<input type="number" id="partialVerse" min="1" placeholder="Ø§Ù„Ø¢ÙŠØ©"></div></div>' +
        '<button class="btn btn-primary btn-small" onclick="savePartialProgress()">ğŸ’¾ Ø­ÙØ¸</button>' +
        '<button class="btn btn-secondary btn-small" onclick="hidePartialProgressForm()">âŒ Ø¥Ù„ØºØ§Ø¡</button></div></div>';
}

function getTodayTask(program) {
    const tasks = generateAllScheduledTasks();
    const todayStr = new Date().toISOString().split('T')[0];
    return tasks.find(t => t.date === todayStr && !t.isCompleted);
}

function renderDelayAlerts(program) {
    const container = document.getElementById('delayAlert');
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    const tasks = generateAllScheduledTasks();
    const missedTasks = tasks.filter(t => t.isPast && !t.isCompleted && t.date !== todayStr);
    
    if (missedTasks.length > 0) {
        container.innerHTML = '<div class="alert alert-warning">âš ï¸ Ù„Ø¯ÙŠÙƒ ' + missedTasks.length + ' Ù…Ù‡Ù…Ø© Ù…ØªØ£Ø®Ø±Ø© Ù„Ù… ØªÙƒØªÙ…Ù„</div>';
    } else {
        container.innerHTML = '';
    }
}

function renderPartialProgressAlert(program) {
    const container = document.getElementById('partialProgressAlert');
    
    if (program.partialProgress) {
        const pp = program.partialProgress;
        const percentage = ((pp.versesCompleted / pp.totalVersesNeeded) * 100).toFixed(1);
        
        container.innerHTML = '<div class="partial-progress">' +
            '<h4>ğŸ“Œ ØªÙ‚Ø¯Ù… Ø¬Ø²Ø¦ÙŠ Ù…Ø­ÙÙˆØ¸</h4>' +
            '<p>ØªÙˆÙ‚ÙØª Ø¹Ù†Ø¯: Ø³ÙˆØ±Ø© ' + SURAH_DATA[pp.stoppedAtSurah - 1].name + ' - Ø§Ù„Ø¢ÙŠØ© ' + pp.stoppedAtVerse + '</p>' +
            '<p>Ø£Ù†Ø¬Ø²Øª: ' + pp.versesCompleted + ' Ù…Ù† ' + pp.totalVersesNeeded + ' Ø¢ÙŠØ© (' + percentage + '%)</p>' +
            '<button class="btn btn-secondary btn-small" onclick="continueFromPartialProgress()">â–¶ï¸ Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ù† Ù‡Ù†Ø§</button>' +
            '<button class="btn btn-danger btn-small" onclick="clearPartialProgress()">ğŸ—‘ï¸ Ù…Ø³Ø­</button></div>';
    } else {
        container.innerHTML = '';
    }
}

function markTaskComplete() {
    const program = getCurrentProgram();
    if (!program) return;
    
    const task = getTodayTask(program);
    if (!task) return;
    
    const todayStr = new Date().toISOString().split('T')[0];
    
    if (!program.completedDays.includes(todayStr)) {
        program.completedDays.push(todayStr);
    }
    
    program.taskHistory.push({
        date: todayStr,
        startSurah: task.startSurah,
        startVerse: task.startVerse,
        endSurah: task.endSurah,
        endVerse: task.endVerse,
        completed: true,
        completedAt: new Date().toISOString()
    });
    
    program.currentVerse = {
        surah: task.endSurah,
        verse: task.endVerse + 1
    };
    
    if (program.currentVerse.verse > SURAH_DATA[program.currentVerse.surah - 1].verses) {
        program.currentVerse.surah++;
        program.currentVerse.verse = 1;
    }
    
    updateStreak(program, todayStr);
    program.partialProgress = null;
    
    saveToStorage();
    alert('ğŸ‰ Ù…Ù…ØªØ§Ø²! ØªÙ… Ø¥ØªÙ…Ø§Ù… Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ…');
    updateMainView();
}

function updateStreak(program, dateStr) {
    const date = new Date(dateStr);
    const yesterday = new Date(date);
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];
    
    if (program.completedDays.includes(yesterdayStr) || !program.lastCompletedDate) {
        program.streak++;
    } else {
        program.streak = 1;
    }
    
    program.lastCompletedDate = dateStr;
}

function getHijriDate(gregorianDate) {
    const greg = new Date(gregorianDate);
    
    let day = greg.getDate();
    let month = greg.getMonth() + 1;
    let year = greg.getFullYear();
    
    let a, b;
    if (month < 3) {
        year -= 1;
        month += 12;
    }
    
    a = Math.floor(year / 100);
    b = 2 - a + Math.floor(a / 4);
    
    const jd = Math.floor(365.25 * (year + 4716)) + Math.floor(30.6001 * (month + 1)) + day + b - 1524.5;
    
    const l = jd - 1948440 + 10632;
    const n = Math.floor((l - 1) / 10631);
    const l2 = l - 10631 * n + 354;
    const j = (Math.floor((10985 - l2) / 5316)) * (Math.floor(50 * l2 / 17719)) + (Math.floor(l2 / 5670)) * (Math.floor(43 * l2 / 15238));
    const l3 = l2 - (Math.floor((30 - j) / 15)) * (Math.floor((17719 * j) / 50)) - (Math.floor(j / 16)) * (Math.floor((15238 * j) / 43)) + 29;
    
    const hijriMonth = Math.floor((24 * l3) / 709);
    const hijriDay = Math.ceil(l3 - Math.floor((709 * hijriMonth) / 24));
    const hijriYear = Math.ceil(30 * n + j - 30);
    
    return {
        day: hijriDay,
        month: HIJRI_MONTHS[hijriMonth - 1],
        year: hijriYear
    };
}

function showPartialProgressForm() {
    document.getElementById('partialProgressForm').classList.remove('hidden');
}

function hidePartialProgressForm() {
    document.getElementById('partialProgressForm').classList.add('hidden');
}

function savePartialProgress() {
    const program = getCurrentProgram();
    if (!program) return;
    
    const task = getTodayTask(program);
    if (!task) return;
    
    const surah = parseInt(document.getElementById('partialSurah').value);
    const verse = parseInt(document.getElementById('partialVerse').value);
    
    if (!verse || verse < 1) {
        alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¢ÙŠØ© ØµØ­ÙŠØ­');
        return;
    }
    
    if (verse > SURAH_DATA[surah - 1].verses) {
        alert('âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† 1 Ùˆ ' + SURAH_DATA[surah - 1].verses);
        return;
    }
    
    const versesCompleted = calculateTotalVerses(task.startSurah, task.startVerse, surah, verse);
    const totalVersesNeeded = calculateTotalVerses(task.startSurah, task.startVerse, task.endSurah, task.endVerse);
    
    if (versesCompleted <= 0 || versesCompleted > totalVersesNeeded) {
        alert('âš ï¸ Ø§Ù„Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­');
        return;
    }
    
    program.partialProgress = {
        date: new Date().toISOString().split('T')[0],
        stoppedAtSurah: surah,
        stoppedAtVerse: verse,
        versesCompleted: versesCompleted,
        totalVersesNeeded: totalVersesNeeded
    };
    
    saveToStorage();
    alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬Ø²Ø¦ÙŠ');
    updateMainView();
}

function continueFromPartialProgress() {
    const program = getCurrentProgram();
    if (!program || !program.partialProgress) return;
    
    const pp = program.partialProgress;
    alert('ğŸ“– ØªØ§Ø¨Ø¹ Ù…Ù† Ø³ÙˆØ±Ø© ' + SURAH_DATA[pp.stoppedAtSurah - 1].name + ' - Ø§Ù„Ø¢ÙŠØ© ' + (pp.stoppedAtVerse + 1));
}

function clearPartialProgress() {
    const program = getCurrentProgram();
    if (!program) return;
    
    if (confirm('âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬Ø²Ø¦ÙŠ Ø§Ù„Ù…Ø­ÙÙˆØ¸ØŸ')) {
        program.partialProgress = null;
        saveToStorage();
        updateMainView();
    }
}

function completeTaskByDate(dateStr, startSurah, startVerse, endSurah, endVerse) {
    const program = getCurrentProgram();
    if (!program) return;
    
    if (!program.completedDays.includes(dateStr)) {
        program.completedDays.push(dateStr);
    }
    
    program.taskHistory.push({
        date: dateStr,
        startSurah: startSurah,
        startVerse: startVerse,
        endSurah: endSurah,
        endVerse: endVerse,
        completed: true,
        completedAt: new Date().toISOString()
    });
    
    const taskDate = new Date(dateStr);
    const today = new Date();
    if (taskDate <= today) {
        program.currentVerse = {
            surah: endSurah,
            verse: endVerse + 1
        };
        
        if (program.currentVerse.verse > SURAH_DATA[program.currentVerse.surah - 1].verses) {
            program.currentVerse.surah++;
            program.currentVerse.verse = 1;
        }
    }
    
    saveToStorage();
    alert('âœ… ØªÙ… Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­!');
    updateMainView();
}

function showAllScheduledTasks() {
    const program = getCurrentProgram();
    if (!program) return;
    
    program.lastHistoryView = 'scheduled';
    saveToStorage();
    setActiveTab(0);
    
    const historyDiv = document.getElementById('historyContent');
    const tasks = generateAllScheduledTasks();
    
    if (tasks.length === 0) {
        historyDiv.innerHTML = '<p class="small-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ø¬Ø¯ÙˆÙ„Ø©</p>';
        return;
    }
    
    historyDiv.innerHTML = tasks.map(task => {
        let statusClass = 'future';
        let statusBadge = 'ğŸ“… Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ';
        let statusBadgeClass = 'status-info';
        
        if (task.isCompleted) {
            statusClass = 'completed';
            statusBadge = 'âœ… Ù…Ù†Ø¬Ø²';
            statusBadgeClass = 'status-success';
        } else if (task.isPast) {
            statusClass = 'delayed';
            statusBadge = 'â° Ù…ØªØ£Ø®Ø±';
            statusBadgeClass = 'status-error';
        } else if (task.isToday) {
            statusClass = '';
            statusBadge = 'ğŸ“ Ø§Ù„ÙŠÙˆÙ…';
            statusBadgeClass = 'status-warning';
        }
        
        const versesCount = calculateTotalVerses(task.startSurah, task.startVerse, task.endSurah, task.endVerse);
        
        let actionButton = '';
        if (!task.isCompleted && (task.isToday || task.isPast)) {
            actionButton = '<div class="task-actions"><button class="btn btn-primary btn-small" onclick="completeTaskByDate(\'' + 
                task.date + '\', ' + task.startSurah + ', ' + task.startVerse + ', ' + task.endSurah + ', ' + task.endVerse + 
                ')">âœ… Ø£Ù†Ø¬Ø² Ø§Ù„Ø¢Ù†</button></div>';
        }
        
        return '<div class="task-card ' + statusClass + '">' +
            '<div class="task-header"><div class="task-info">' +
            '<span class="task-number">' + task.taskNumber + '</span>' +
            formatDate(new Date(task.date)) + '</div>' +
            '<span class="status-badge ' + statusBadgeClass + '">' + statusBadge + '</span></div>' +
            '<div class="task-range"><strong>Ù…Ù†:</strong> Ø³ÙˆØ±Ø© ' + task.startSurahName + ' - Ø§Ù„Ø¢ÙŠØ© ' + task.startVerse + '<br>' +
            '<strong>Ø¥Ù„Ù‰:</strong> Ø³ÙˆØ±Ø© ' + task.endSurahName + ' - Ø§Ù„Ø¢ÙŠØ© ' + task.endVerse + '<br>' +
            '<strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¢ÙŠØ§Øª:</strong> ' + versesCount + ' Ø¢ÙŠØ©</div>' +
            actionButton + '</div>';
    }).join('');
}

function showCompletedHistory() {
    const program = getCurrentProgram();
    if (!program) return;
    
    program.lastHistoryView = 'completed';
    saveToStorage();
    setActiveTab(1);
    
    const historyDiv = document.getElementById('historyContent');
    const completedTasks = program.taskHistory.filter(t => t.completed);
    
    if (completedTasks.length === 0) {
        historyDiv.innerHTML = '<p class="small-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ù†Ø¬Ø²Ø© Ø¨Ø¹Ø¯</p>';
        return;
    }
    
    historyDiv.innerHTML = completedTasks.reverse().map(task => {
        const versesCount = calculateTotalVerses(task.startSurah, task.startVerse, task.endSurah, task.endVerse);
        
        return '<div class="task-card completed">' +
            '<div class="task-header"><div class="task-info">' +
            formatDate(new Date(task.date)) + '</div>' +
            '<span class="status-badge status-success">âœ… Ù…Ù†Ø¬Ø²</span></div>' +
            '<div class="task-range"><strong>Ù…Ù†:</strong> Ø³ÙˆØ±Ø© ' + SURAH_DATA[task.startSurah - 1].name + ' - Ø§Ù„Ø¢ÙŠØ© ' + task.startVerse + '<br>' +
            '<strong>Ø¥Ù„Ù‰:</strong> Ø³ÙˆØ±Ø© ' + SURAH_DATA[task.endSurah - 1].name + ' - Ø§Ù„Ø¢ÙŠØ© ' + task.endVerse + '<br>' +
            '<strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¢ÙŠØ§Øª:</strong> ' + versesCount + ' Ø¢ÙŠØ©</div>' +
            '<div class="task-actions">' +
            '<button class="btn btn-secondary btn-small" onclick="editCompletedTask(\'' + task.date + '\')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>' +
            '</div></div>';
    }).join('');
}

function showPendingHistory() {
    const program = getCurrentProgram();
    if (!program) return;
    
    program.lastHistoryView = 'pending';
    saveToStorage();
    setActiveTab(2);
    
    const historyDiv = document.getElementById('historyContent');
    const tasks = generateAllScheduledTasks();
    const pendingTasks = tasks.filter(t => t.isPast && !t.isCompleted);
    
    if (pendingTasks.length === 0) {
        historyDiv.innerHTML = '<p class="small-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…Ø¹Ù„Ù‚Ø©! Ù…Ù…ØªØ§Ø²! ğŸ‰</p>';
        return;
    }
    
    historyDiv.innerHTML = pendingTasks.map(task => {
        const versesCount = calculateTotalVerses(task.startSurah, task.startVerse, task.endSurah, task.endVerse);
        
        return '<div class="task-card delayed">' +
            '<div class="task-header"><div class="task-info">' +
            '<span class="task-number">' + task.taskNumber + '</span>' +
            formatDate(new Date(task.date)) + '</div>' +
            '<span class="status-badge status-error">â° Ù…ØªØ£Ø®Ø±</span></div>' +
            '<div class="task-range"><strong>Ù…Ù†:</strong> Ø³ÙˆØ±Ø© ' + task.startSurahName + ' - Ø§Ù„Ø¢ÙŠØ© ' + task.startVerse + '<br>' +
            '<strong>Ø¥Ù„Ù‰:</strong> Ø³ÙˆØ±Ø© ' + task.endSurahName + ' - Ø§Ù„Ø¢ÙŠØ© ' + task.endVerse + '<br>' +
            '<strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¢ÙŠØ§Øª:</strong> ' + versesCount + ' Ø¢ÙŠØ©</div></div>';
    }).join('');
}

function generateAllScheduledTasks() {
    const program = getCurrentProgram();
    if (!program) return [];
    
    const tasks = [];
    const excludedDaysSet = new Set(program.excludedDays);
    const completedDaysSet = new Set(program.completedDays);
    
    let currentDate = new Date(program.startDate);
    let currentSurah = program.startSurah;
    let currentVerse = program.startVerse;
    
    let taskNumber = 1;
    const todayStr = new Date().toISOString().split('T')[0];
    const today = new Date(todayStr);
    const maxTasks = program.totalDays || 1000;
    
    while (taskNumber <= maxTasks && (currentSurah < program.endSurah || (currentSurah === program.endSurah && currentVerse <= program.endVerse))) {
        const dateStr = currentDate.toISOString().split('T')[0];
        
        if (!isExcludedDay(currentDate, excludedDaysSet)) {
            const task = {
                taskNumber: taskNumber,
                date: dateStr,
                startSurah: currentSurah,
                startSurahName: SURAH_DATA[currentSurah - 1].name,
                startVerse: currentVerse
            };
            
            let versesNeeded = program.versesPerDay;
            let endSurah = currentSurah;
            let endVerse = currentVerse;
            
            while (versesNeeded > 0) {
                const versesInCurrentSurah = SURAH_DATA[endSurah - 1].verses;
                const versesLeftInSurah = versesInCurrentSurah - endVerse;
                
                if (versesLeftInSurah >= versesNeeded) {
                    endVerse += versesNeeded;
                    versesNeeded = 0;
                } else {
                    versesNeeded -= (versesLeftInSurah + 1);
                    endSurah++;
                    endVerse = 1;
                    
                    if (endSurah > program.endSurah) {
                        endSurah = program.endSurah;
                        endVerse = program.endVerse;
                        versesNeeded = 0;
                    }
                }
            }
            
            if (endSurah > program.endSurah || (endSurah === program.endSurah && endVerse > program.endVerse)) {
                endSurah = program.endSurah;
                endVerse = program.endVerse;
            }
            
            task.endSurah = endSurah;
            task.endSurahName = SURAH_DATA[endSurah - 1].name;
            task.endVerse = endVerse;
            task.isCompleted = completedDaysSet.has(dateStr);
            task.isToday = dateStr === todayStr;
            task.isPast = currentDate < today && !task.isToday;
            task.isFuture = !task.isToday && !task.isPast;
            
            tasks.push(task);
            taskNumber++;
            
            currentSurah = endSurah;
            currentVerse = endVerse + 1;
            
            if (currentVerse > SURAH_DATA[currentSurah - 1].verses) {
                currentSurah++;
                currentVerse = 1;
            }
            
            if (currentSurah > program.endSurah || (currentSurah === program.endSurah && currentVerse > program.endVerse)) {
                break;
            }
        }
        
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    return tasks;
}

function editCompletedTask(dateStr) {
    const program = getCurrentProgram();
    if (!program) {
        alert('âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬');
        return;
    }
    
    if (confirm('âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ù†Ø¬Ø²Ø© ÙÙŠ ' + formatDate(new Date(dateStr)) + 'ØŸ')) {
        const index = program.completedDays.indexOf(dateStr);
        if (index > -1) {
            program.completedDays.splice(index, 1);
        }
        
        program.taskHistory = program.taskHistory.filter(t => t.date !== dateStr);
        
        if (program.completionHistory[dateStr]) {
            delete program.completionHistory[dateStr];
        }
        
        recalculateCurrentPosition(program);
        
        saveToStorage();
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ù†Ø¬Ø²Ø©');
        updateMainView();
    }
}

function recalculateCurrentPosition(program) {
    if (program.taskHistory.length === 0) {
        program.currentVerse = {
            surah: program.startSurah,
            verse: program.startVerse
        };
        program.streak = 0;
        program.lastCompletedDate = null;
        return;
    }
    
    const sortedHistory = program.taskHistory
        .filter(t => t.completed)
        .sort((a, b) => new Date(a.date) - new Date(b.date));
    
    if (sortedHistory.length > 0) {
        const lastTask = sortedHistory[sortedHistory.length - 1];
        program.currentVerse = {
            surah: lastTask.endSurah,
            verse: lastTask.endVerse + 1
        };
        
        if (program.currentVerse.verse > SURAH_DATA[program.currentVerse.surah - 1].verses) {
            program.currentVerse.surah++;
            program.currentVerse.verse = 1;
        }
        
        program.lastCompletedDate = lastTask.date;
    }
}

function deleteCurrentProgram() {
    const program = getCurrentProgram();
    if (!program) {
        alert('âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬');
        return;
    }
    
    if (confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ØŸ Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.')) {
        allPrograms = allPrograms.filter(p => p.id !== currentProgramId);
        currentProgramId = null;
        saveToStorage();
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬');
        showMenuView();
    }
}

function formatDate(date) {
    const day = date.getDate();
    const gregMonth = GREGORIAN_MONTHS_ARABIC[date.getMonth()];
    const gregYear = date.getFullYear();
    const hijri = getHijriDate(date);
    return hijri.day + ' ' + hijri.month + ' ' + hijri.year + ' | ' + day + ' ' + gregMonth + ' ' + gregYear;
}

init();
    </script>
</body>
</html>